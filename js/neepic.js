function NeepicWordpressPlugin() {    var textarea;    var base_url = 'http://neepic.net/';    var api_url = 'http://api.neepic.net/';    function init() {        textarea = getTextarea();        if(!textarea){            return;        }        var div = document.createElement('div');        var input = document.createElement('input');        input.id = 'neepic-input';        input.style.position = 'absolute';        input.style.top = '-9999px';        input.style.left = '-9999px';        input.type = 'file';        input.addEventListener('change', upload, false);        var link = document.createElement('a');        link.id = 'neepic-label';        link.innerHTML = neepicL10n.add_image;        link.onclick = function() {            input.click();            return false;        };        link.href = '#';        div.appendChild(link);        div.appendChild(input);        textarea.parentNode.appendChild(div);    }    function getTextarea(){        var areaArray = document.getElementsByTagName('textarea');        for (var i = 0; i < areaArray.length; i++) {            if (areaArray[i].id.match(/comment/i)) {                return areaArray[i];            }        }    }    function upload(e) {        var file = e.target.files[0];        var formData = new FormData();        formData.append('pic', file);        formData.append('from_plugin', 1);        var neepic_label = document.getElementById('neepic-label');        neepic_label.innerHTML = neepicL10n.uploading+' 0%';        var xhr = new XMLHttpRequest();        xhr.open('POST', api_url+'upload', true);        xhr.onload = function() {            var data = JSON.parse(xhr.responseText);            if(data.response == 0) {                alert(data.message);                e.target.value = null;                neepic_label.innerHTML = neepicL10n.add_image;                return;            }            var code = '[neepic id="' + data.id + '" name="'+ data.name +'" preview="'+ data.preview +'"]';            if (window.tinyMCE && window.tinyMCE.activeEditor && !tinyMCE.activeEditor.isHidden()) {                window.tinyMCE.activeEditor.setContent(window.tinyMCE.activeEditor.getContent() + code);            } else {                textarea.value = textarea.value + code;            }            e.target.value = null;            neepic_label.innerHTML = neepicL10n.add_image;        };        xhr.upload.onprogress = function(e) {            var progress = parseInt(e.loaded / e.total * 100, 10);            neepic_label.innerHTML = neepicL10n.uploading+' '+progress+'%';            if(progress==100){                neepic_label.innerHTML = neepicL10n.saving;            }        };        xhr.send(formData);    }    if (window.addEventListener) {        window.addEventListener('DOMContentLoaded', init, false);    } else if (window.attachEvent) {        window.attachEvent('onload', init);    }}var NeepicWordpressPlugin = new NeepicWordpressPlugin();